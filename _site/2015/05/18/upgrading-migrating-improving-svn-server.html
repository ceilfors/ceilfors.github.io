<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
        Guide on upgrading, migrating, and improving SVN Server
    </title>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css" type="text/css">
    <link rel="stylesheet" href="/css/darkly.css" type="text/css">
    <link rel="stylesheet" href="/css/main.css" type="text/css">
    <link rel="stylesheet" href="/css/image.css" type="text/css">

</head>
<body>
    <div class="site">
        <div class="container pure-g-r">
            <div class="pure-u-1">
                <header class="title">
                    <h3>
                        <a href="/">ceilfors</a>
                    </h3>
                </header>
                <div class="content">
                    
<h1 class="post-title">Guide on upgrading, migrating, and improving SVN Server</h1>
<span class="meta" style="color:grey">
18 May 2015 - 
Read time: 7 min.
</span>
<br />

<div class="post">
    <p>Long story short, this guide will help you to go from the <em>current state</em> to the <em>envisioned state</em>.</p>

<p><strong>Current state:</strong></p>

<ul>
<li>SVN Server 1.4.6 - Released December 2007</li>
<li>RHEL 4 - Released November 2007</li>
<li>Maintenance hell - authz and passwd for every SVN repositories</li>
</ul>

<p><strong>Envisioned state:</strong></p>

<ul>
<li>SVN Server 1.8.13 - Released March 2015</li>
<li>SLES - Released July 2013</li>
<li>SSO with LDAP group as authorization strategy and a single authz file</li>
<li>DNS and SSL offloading via reverse proxy</li>
</ul>

<h2>Exporting the repository</h2>

<p>To migrate a SVN repository, you must export or <em>dump</em> the repository, transfer it over to the new server, and load it to a new repository. The export process will produce a dump file.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">svnadmin dump /svn/myrepository &gt; myrepository.dump
</code></pre></div>
<p>The dump file can be pretty huge, so gzipping it will greatly reduce the file on disk.</p>

<p>While you are waiting on the dumping process, you might have found that you can actually <code>scp</code> or <code>rsync</code> the SVN repository directory and call <code>svnadmin upgrade</code> directly. This is a lot faster than dumping and loading a repository. If you are upgrading the SVN server, my recommendation is <em>don&#39;t do</em> this. This is the quote from <code>svnadmin help upgrade</code>:</p>

<blockquote>
<p>This functionality is provided as a convenience for repository
administrators who wish to make use of new Subversion functionality
without having to undertake a potentially costly full repository dump
and load operation.  As such, the upgrade performs only the minimum
amount of work needed to accomplish this while still maintaining the
integrity of the repository. <strong>It does not guarantee the most optimized
repository state as a dump and subsequent load would</strong>.</p>
</blockquote>

<h2>Repairing the dump - non-LF line endings</h2>

<p>If your SVN repository is as old as ours, you might hit the error below:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">svnadmin: E125005: Invalid property value found in dumpstream; consider repairing the source or using --bypass-prop-validation while loading.
svnadmin: E125005: Cannot accept non-LF line endings in &#39;svn:log&#39; property
</code></pre></div>
<p>This error is caused by carriage return characters (Control+M / ^M) stored in those properties. I will not recommend using <code>--bypass-prop-validation</code> nor using <code>sed</code>. <code>--bypass-prop-validation</code> is just going to postpone problems.</p>

<p>Removing ^M characters with <code>sed</code> seems viable, but the problem is you can&#39;t actually <em>remove</em> them, you can only <em>replace</em> the them. This is because the dump files are storing a variable called <code>Prop-content-length</code> which is storing the actual length of the property. If you remove the characters which reduces the actual property length, a dump file is deemed corrupted and you won&#39;t be able to load it. Wrong regex will also potentially <strong>corrupt the binary files</strong> stored in the dump files.</p>

<p>My recommendation is to use <a href="https://github.com/jwiegley/svndumptool">svndumptool</a>. This tool completely removes the ^M characters properly and it will also adjust the <code>Prop-content-length</code> and <code>Content-length</code> respectively.</p>

<p>This non-LF line endings error is happening for me on svn:log, svn:ignore and svn:externals. So the commands that I have executed to the dump files are:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">svndumptool.py eolfix-prop svn:externals in out
svndumptool.py eolfix-prop svn:ignore in out
svndumptool.py eolfix-revprop svn:log in out
</code></pre></div>
<p>It&#39;s crucial to determine if a property requires <code>eolfix-prop</code> or <code>eolfix-revprop</code> option to make svndumptool work correctly. To determine which one you need, refer to <a href="http://svnbook.red-bean.com/en/1.7/svn.ref.properties.html">SVN Properties</a> documentation and get the list of Versioned and Unversioned properties, then map it like so:</p>

<ul>
<li>Versioned Properties: eolfix-prop</li>
<li>Unversioned Properties: eolfix-revprop</li>
</ul>

<h2>Repairing the dump - svn:externals</h2>

<p>Most of our <strong>svn:externals</strong> are having absolute URLs. This will no longer work in our new server. The fastest way to resolve this issue is to repair the dump files.</p>

<p>To list down all of the currently used svn:externals, you will need to recursively check each of the directories in your SVN repositories. Because our repositories are huge, we need a quick way to extract these properties. In order to do this, I have written a python script that you can use here: <a href="https://gist.github.com/ceilfors/741d8152106a310dd454">externals.py</a>. (Credits to <a href="http://stackoverflow.com/a/10286163/2464295">NeoSkye</a>).</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">externals.py file:///svn/repository
</code></pre></div>
<p>Notice that I&#39;m using file protocol as this will quicken the process by not consuming network. You will need to of course SSH to the server. Once you have all of the svn:externals extracted out, figure out what kind of patterns or syntax that have been used in your SVN repositories.</p>

<p>Next we are ready to edit those dump files. I&#39;m using <a href="https://github.com/jwiegley/svndumptool">svndumptool</a> again here which works like a charm. It is good to migrate all of the reference to the server and change them to become a relative URL. In my case, I only have two patterns:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">svndumptool.py transform-prop svn:externals &quot;^(svn://server-name/uk/)(/.*)&quot; &quot;/relativeroot\2&quot; in out
svndumptool.py transform-prop svn:externals &quot;(\S*)\s+(svn://server-name/uk)(/\S*)&quot; &quot;/relativeroot\3 \1&quot; in out
</code></pre></div>
<p>To migrate various other svn:externals format, refer to this <a href="http://stackoverflow.com/questions/21292688/regex-for-svndumptool">SO thread</a>.</p>

<h2>Importing and finalizing migration</h2>

<p>Do the following in the new server:</p>

<ul>
<li>Create a new SVN repository</li>
<li>Load the dump that you have repaired</li>
<li>Verify the repository (I think this is optional, but just in case)</li>
<li>Copy the previously configured hooks you have</li>
</ul>
<div class="highlight"><pre><code class="language-text" data-lang="text">svnadmin create --compatible-version 1.4.6 repository_path
svnadmin load --force-uuid $REPOSITORY &lt; repaired_dump_file
svnadmin verify repository_path
rsync --exclude &quot;*.tmpl&quot; user@old-server:old_repository_path/hooks/* repository_path/hooks
</code></pre></div>
<h2>Improving authentication and authorization strategy</h2>

<p>In the <em>envisioned state</em>, I want to use SSO as our authentication strategy. Since we are using CollabNet Subversion Edge 4.0.14, it is very easy to setup SSO as everything is GUI based and everything is already well integrated.</p>

<p>The authorization part is the tricky bit. Previously we have a problem where each of the SVN repositories are having their own authz files, and it is a nightmare to migrate all of them to a single authz file in SVN Edge. The solution that I come up with is to use LDAP groups to authorize SVN users. It is however not simple to achieve this in SVN server because the authorization is tight to authz file.</p>

<p>A very handy script called <a href="https://github.com/dr4Ke/ldap-to-svn-authz">ldap-to-authz</a> will do the trick. As of writing, I would recommend you to grab the script from <a href="https://github.com/dr4Ke/ldap-to-svn-authz">dr4Ke GitHub repository</a> instead of from the <a href="https://bitbucket.org/whitlockjc/jw-tools">original whitlockjc bitbucket repository</a>. The one maintained by dr4Ke have the following benefits:</p>

<ol>
<li>Extra option to follow nested LDAP groups</li>
<li>Extra option to grab specific LDAP groups instead of scanning the whole LDAP server.</li>
</ol>

<p>Read the script&#39;s documentation on how you can make use of it. The rest is pretty straightforward, basically you will need to write a script to merge these:</p>

<ol>
<li>Your changes via SVN Edge UI</li>
<li>The automatically generated LDAP group content from ldap-to-authz</li>
</ol>

<p>Then run the script in cron. You can get the script <a href="http://serverfault.com/a/401181">here</a> for reference. In addition to the merging, I also backup the previous authz file every time the cron runs.</p>

<h2>Pretty URL with https</h2>

<p>To have a pretty URL with https, you need to have a DNS that points to a reverse proxy,
and a reverse proxy that forwards port 443 to 18080. This generates some problems.</p>

<p>Without configuring SVN Edge, you will not be able do an SVN move or copy:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">COPY request on &#39;/svn/foo/!svn/rvr/3880/project/trunk&#39;
failed: 502 Bad Gateway
</code></pre></div>
<p>This is happening because we are forwarding https to http. To resolve this issue, you need to configure <code>csvn/data/conf/httpd.conf</code> and <code>csvn/dist/httpd.conf.dist</code>. Simply add the following snippets to the end of the file:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">LoadModule headers_module lib/modules/mod_headers.so
RequestHeader edit Destination ^https http early
</code></pre></div>
<p>Another small problem that you might encounter is in ViewVC. At every bottom of a page, ViewVC shows a <code>svn checkout</code> command guide. This checkout URL will not be reflected to your DNS and reverse proxy. To configure this, you will need to add the below snippet to <code>csvn/dist/viewvc.conf.dist</code> and restart it.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">csvn_svn_base_url=https://pretty-url/svn/
</code></pre></div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ceilfors'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
                <footer class="footer">
                    <span>Wisen Tanasa</span><br>
                    <a href="https://github.com/ceilfors">github.com/ceilfors</a><br>
                    <a href="https://twitter.com/ceilfors">twitter.com/ceilfors</a><br>
                </footer>
            </div>
        </div>
    </div>
    <script src="/js/matchmedia.js"></script>
    <script src="/js/picturefill.min.js"></script>    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-48262088-1', 'ceilfors.com');
      ga('send', 'pageview');

    </script>
</body>
</html>
