<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
        Automating Signing of Launch4j's exe with Python
    </title>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css" type="text/css">
    <link rel="stylesheet" href="/css/darkly.css" type="text/css">
    <link rel="stylesheet" href="/css/main.css" type="text/css">
    <link rel="stylesheet" href="/css/image.css" type="text/css">

</head>
<body>
    <div class="site">
        <div class="container pure-g-r">
            <div class="pure-u-1">
                <header class="title">
                    <h3>
                        <a href="/">ceilfors</a>
                    </h3>
                </header>
                <div class="content">
                    
<h1 class="post-title">Automating Signing of Launch4j's exe with Python</h1>
<span class="meta" style="color:grey">
20 Dec 2014 - 
Read time: 2 min.
</span>
<br />

<div class="post">
    <p>One of the manual release step that we have is to sign the installers of our products.
This simple step is made complicated by launch4j. The steps that were in place
was from this <a href="http://sourceforge.net/p/launch4j/discussion/332683/thread/4e9e2558">discussion here</a>
and I&#39;m addressing the most errorneous step of it with a python script in this post:</p>

<blockquote>
<p>Edit test.exe with favorite HEX editor to change last two bytes of exe i.e. the jar i.e.
the zip end of central directory to the size using littleendian byte order and save</p>
</blockquote>

<p>You will find my script spitting a lot of information as I was not confident enough
playing with bytes in python. They were helpful to compare the result when we did 
it manually.</p>

<p>This is the function in my script that is modifying the last two bytes of the exe by utilising mmap.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">hack_footer</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">difference_in_bytes</span><span class="p">):</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>   
    <span class="n">mm</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">mm</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">lastbytes</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lastbytes</span> <span class="o">!=</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\x00\x00</span><span class="s">&quot;</span><span class="p">):</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;File is in an invalid state: Last bytes is not 00&quot;</span><span class="p">)</span>
 
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Before: {} (HEX: {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lastbytes</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">lastbytes</span><span class="p">)))</span>
 
    <span class="n">mm</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">mm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">difference_in_bytes</span><span class="p">)</span>
    <span class="n">mm</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">lastbytes</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;After: {} (HEX: {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lastbytes</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">lastbytes</span><span class="p">)))</span>
 
    <span class="n">mm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>

<p>To calculate the difference_in_bytes was pretty straightforward:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">calculate_difference_in_bytes</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">signed</span><span class="p">):</span>
  <span class="n">signed_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">signed</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
  <span class="n">original_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">original</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
 
  <span class="n">size_difference</span> <span class="o">=</span> <span class="n">signed_size</span> <span class="o">-</span> <span class="n">original_size</span>
  <span class="n">size_difference_bytes</span> <span class="o">=</span> <span class="n">size_difference</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s">&#39;little&#39;</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s">&quot;Original size: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">original_size</span><span class="p">))</span>
  <span class="k">print</span><span class="p">(</span><span class="s">&quot;Signed size: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signed_size</span><span class="p">))</span>
  <span class="k">print</span><span class="p">(</span><span class="s">&quot;Size difference: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size_difference</span><span class="p">))</span>
  <span class="k">print</span><span class="p">(</span><span class="s">&quot;Size in bytes difference: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size_difference_bytes</span><span class="p">))</span>
 
  <span class="k">return</span> <span class="n">size_difference_bytes</span></code></pre></div>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ceilfors'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
                <footer class="footer">
                    <span>Wisen Tanasa</span><br>
                    <a href="https://github.com/ceilfors">github.com/ceilfors</a><br>
                    <a href="https://twitter.com/ceilfors">twitter.com/ceilfors</a><br>
                </footer>
            </div>
        </div>
    </div>
    <script src="/js/matchmedia.js"></script>
    <script src="/js/picturefill.min.js"></script>    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-48262088-1', 'ceilfors.com');
      ga('send', 'pageview');

    </script>
</body>
</html>
